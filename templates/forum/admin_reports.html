{% extends "base.html" %}
{% load profile_tags %}

{% block title %}จัดการรายงาน • Dino Forum{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">รายงาน</h1>
  <div class="text-muted small">เฉพาะผู้ดูแลระบบ</div>
</div>

<form class="row g-2 align-items-center mb-3" method="get">
  <div class="col-12 col-md-10">
    <input class="form-control" type="search" name="q"
           placeholder="ค้นหาเหตุผล/ชนิด/เป้าหมาย"
           value="{{ q }}">
  </div>
  <div class="col-12 col-md-2 d-grid">
    <button class="btn btn-primary">ค้นหา</button>
  </div>
</form>

<div class="table-responsive">
  <table class="table table-dark table-striped align-middle">
    <thead>
      <tr>
        <th style="width:80px">ID</th>
        <th style="width:100px">ชนิด</th>
        <th style="width:220px">เป้าหมาย</th>
        <th>เหตุผล</th>
        <th style="width:160px">ผู้รายงาน</th>
        <th style="width:160px">เวลา</th>
        <th style="width:240px">การจัดการ</th>
      </tr>
    </thead>
    <tbody>
    {% for r in page_obj.object_list %}
      <tr>
        <td>#{{ r.id }}</td>
        <td>{{ r.target_type }}</td>
        <td>
          {# ลิงก์ไปยังโพสต์ #}
          {% if r.target_type == "thread" %}
            <a href="{% url 'forum:thread_detail' thread_id=r.thread_id|default:r.target_id %}" target="_blank">
              กระทู้ #{{ r.thread_id|default:r.target_id }}
            </a>
          {% elif r.target_type == "comment" %}
            {% if r.thread_id %}
              <a href="{% url 'forum:thread_detail' thread_id=r.thread_id %}#comment-{{ r.target_id }}" target="_blank">
                คอมเมนต์ #{{ r.target_id }} (กระทู้ #{{ r.thread_id }})
              </a>
            {% else %}
              <span class="text-muted">ไม่พบโพสต์</span>
            {% endif %}
          {% else %}
            <span class="text-muted">ไม่ทราบชนิด</span>
          {% endif %}
        </td>

        <td class="wrap-anywhere">{{ r.reason|default:"—" }}</td>
        <td>{{ r.reporter|display_name }}</td>
        <td>{{ r.created_at|date:"Y-m-d H:i" }}</td>

        <td class="d-flex gap-2">
          {# ลบเป้าหมาย #}
          <form method="post"
                action="{% url 'adminpanel:report_delete_target' rid=r.id %}"
                class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button class="btn btn-sm btn-danger"
                    onclick="return confirm('ยืนยันลบเป้าหมายนี้หรือไม่?');">
              ลบเป้าหมาย
            </button>
          </form>

          {# ปิดรายงาน #}
          <form method="post"
                action="{% url 'adminpanel:report_resolve' rid=r.id %}"
                class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button class="btn btn-sm btn-success"
                    {% if r.resolved %}disabled title="ปิดรายงานแล้ว"{% endif %}>
              {% if r.resolved %}ปิดแล้ว{% else %}ปิดรายงาน{% endif %}
            </button>
          </form>
        </td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="7" class="text-center text-muted py-5">ยังไม่มีรายงาน</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<nav class="mt-3">
  <ul class="pagination mb-0">
    {% if page_obj.has_previous %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q }}">«</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">«</span></li>
    {% endif %}
    <li class="page-item disabled"><span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>
    {% if page_obj.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q }}">»</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">»</span></li>
    {% endif %}
  </ul>
</nav>
{% endblock %}
